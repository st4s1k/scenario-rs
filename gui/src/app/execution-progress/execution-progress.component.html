<div class="execution-progress">
  @if (currentStepIndex() == -1 || displaySteps.length === 0) {
  <div class="empty-state">No steps to display</div>
  } @else {
  @for (displayStep of displaySteps.slice(0, currentStepIndex() + 1); track displayStep.step.index) {
  <expandable [ngClass]="variant" [label]="'[' + (displayStep.step.index + 1) + '] ' + displayStep.step.task.description" [(expanded)]="displayStep.expanded"
    [showSeparator]="$index > 0 && !displaySteps[$index - 1].expanded">
    <div class="status-indicator" [ngClass]="displayStep.status" beforeLabel></div>
    <div class="task">
      @let state = displayStep.state();

      @switch (displayStep.step.task.task_type) {
      @case ('RemoteSudo') {
      <div class="task-item">
        <info-block label="Command" variant="primary">
          @let command = state && state.type === 'RemoteSudoState' && state.command
          ? state.command
          : displayStep.step.task.command;
          <input class="text-field" type="text" [value]="command" readonly />
        </info-block>
      </div>

      <div class="task-item">
        @let output = state && state.type === 'RemoteSudoState' && state.output
        ? state.output
        : '';
        <info-block class="output" label="Output" variant="secondary">
          <textarea wrap="off" spellcheck="false" [autoScroll]="displayStep.state" readonly>{{ output }}</textarea>
        </info-block>
      </div>

      @if (displayStep.status === 'executing') {
      <div class="executing-indicator">
        <div class="dot-pulse"></div>
      </div>
      }
      }
      @case ('SftpCopy') {
      <div class="task-item">
        <info-block label="Source" variant="primary">
          @let source = state && state.type === 'SftpCopyState'
          ? state.source
          : displayStep.step.task.source_path;
          <input class="text-field" type="text" [value]="source" readonly>
        </info-block>

        <info-block label="Destination" variant="primary">
          @let destination = state && state.type === 'SftpCopyState'
          ? state.destination
          : displayStep.step.task.destination_path;
          <input class="text-field" type="text" [value]="destination" readonly />
        </info-block>

        @let total = state && state.type === 'SftpCopyState' ? state.total : 0;
        @let current = state && state.type === 'SftpCopyState' ? state.current : 0;
        @let progress = total == 0 ? 0 : Math.round((current / total) * 100);
        <div class="progress-bar" role="progressbar" aria-label="File transfer progress" [attr.aria-valuemin]="0"
          [attr.aria-valuemax]="total" [attr.aria-valuenow]="current"
          [attr.data-content]="progress + '% (' + formatBytes(current) + ' / ' + formatBytes(total) + ')'"
          [style.--progress-percentage]="progress + '%'">
        </div>
      </div>
      }
      }

      @if (displayStep.status === 'failed') {
      <div class="task-item">
        <info-block class="error" label="Error" variant="error">
          <textarea spellcheck="false" readonly>{{ displayStep.errorMessage }}</textarea>
        </info-block>
      </div>
      }
    </div>
  </expandable>
  }
  }
</div>
